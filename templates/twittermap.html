<!DOCTYPE html>
<html>
<head>
	<title>US Map Demo</title>
	<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no' />
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
  	<link href='//api.tiles.mapbox.com/mapbox.js/v1.6.0/mapbox.css' rel='stylesheet' />
  	<script src='//api.tiles.mapbox.com/mapbox.js/v1.6.0/mapbox.js'></script>
  	<style>
  		#map-basic, #map-twitter-mood { 
	  		position:absolute; 
	  		width:100%; 
	  		height:100%;
	  	}
	  	body {
	  		margin: 0;
	  	}
	</style>
</head>
<body>
  <div id="map-twitter-mood"></div>
  <style>
	  	.map-legend ul {
	  		padding-left: 0;
	  	}
	  	.map-legend li {
	  		list-style: none;
	  	}
	  	.map-legend .swatch {
			width:20px;
			height:20px;
			float:left;
			margin-right:10px;
		}
		.leaflet-popup-close-button {
			display: none;
		}
		.leaflet-popup-content-wrapper {
			pointer-events: none;
		}
	</style>
  	<script>
  		var maptwittermood = L.mapbox.map('map-twitter-mood', 'jdf3ha.h2gdddi3')
			      .setView([37.8, -96], 4);

		var stateData = null;
		var moodData = null;

		var statesLayer = null;

		var popup = new L.Popup({ autoPan: false });

		function setGeoJson() {
			statesLayer = L.geoJson(statesData,  {
		        onEachFeature: onEachFeature
		    }).addTo(maptwittermood);
		}

		function refreshMood() {
		    statesLayer.setStyle(getStyle);
		}

		function getStyle(feature) {
	        return {
	            weight: 1,
	            opacity: 0.1,
	            color: 'black',
	            fillOpacity: 0.3,
	            fillColor: getColor(feature.properties.abbrev)
	        };
	    }

	    function getColor(a) {
	        if (a in moodData) {
	        	return moodData[a]['color'];
	        }
	        return "";
	    }

	    function onEachFeature(feature, layer) {
	        layer.on({
	            mousemove: mousemove,
	            mouseout: mouseout,
	            click: zoomToFeature
	        });
	    }

	    var closeTooltip;

	    function mousemove(e) {
	        var layer = e.target;

	        var moodscore = parseFloat(moodData[layer.feature.properties.abbrev]['mood_score']).toFixed(3);
	        var sentiment = parseFloat(moodData[layer.feature.properties.abbrev]['sentiment']).toFixed(3);
	        var count = moodData[layer.feature.properties.abbrev]['count'];
	        var std = parseFloat(moodData[layer.feature.properties.abbrev]['std']).toFixed(3);

	        popup.setLatLng(e.latlng);
	        popup.setContent('<div class="marker-title">' + layer.feature.properties.name + '</div>' +
	            '<b>Mood Score: </b> ' + moodscore + '<br/><b>Average Sentiment: </b>' + sentiment + '<br/><b>Number of Tweets: </b> ' + count + '</br><b>Standard Deviation:</b> ' + std);

	        if (!popup._map) popup.openOn(maptwittermood);
	        window.clearTimeout(closeTooltip);

	        // highlight feature
	        layer.setStyle({
	            weight: 3,
	            opacity: 0.3,
	            fillOpacity: 0.9
	        });

	        if (!L.Browser.ie && !L.Browser.opera) {
	            layer.bringToFront();
	        }
	    }

	    function mouseout(e) {
	        var layer = e.target;
	        layer.setStyle({
	            weight: 1,
	            opacity: 0.1,
	            fillOpacity: 0.3
	        });
	        closeTooltip = window.setTimeout(function() {
	            maptwittermood.closePopup();
	        }, 100);
	    }

	    function zoomToFeature(e) {
	        maptwittermood.fitBounds(e.target.getBounds());
	    }

	    maptwittermood.legendControl.addLegend(getLegendHTML());

	    function getLegendHTML() {
	      	labels = [];
	        labels.push('<li><span class="swatch" style="background:green"></span>Positive</li>');
	        labels.push('<li><span class="swatch" style="background:yellow"></span>Nuetral</li>');
	        labels.push('<li><span class="swatch" style="background:red"></span>Negative</li>');
	      	return '<span>Mood Legend</span><ul>' + labels.join('') + '</ul>';
	    }

	    function updateMap() {
	    	jQuery.getJSON('/', function(d) {
	  			moodData = d;
	  			refreshMood();
			});
	    }

	  	// Get state json info
	  	jQuery.getJSON('/static/us-states.json', function(data){
	  		statesData = data;
	  		setGeoJson();
	  		updateMap();
		});

		setInterval(function() {updateMap();}, 10000)
	
	</script>
</body>
</html>
